{% extends 'store/base.html' %}

{% load static %}

{% block content %}

    <style>

    </style>

    <div class="site-section">
        <div class="container">
            <div class="align-content-center">
                <article class="text-black">
                    <div>
                        Order Name:
                        <h3 class="h3">{{ order_item.order.order_name }}</h3>
                    </div>
                    <div class="offset-sm-10"></div>
                    <table class="table">
                        <thead class="card-header">
                        <tr>
                            <th colspan="2">Order Details</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Customer Full Name</td>
                            <td>{{ order_item.order.first_name|title }} {{ order_item.order.last_name|title }}</td>
                        </tr>
                        <tr>
                            <td>Region</td>
                            <td>{{ order_item.order.region }}</td>
                        </tr>
                        <tr>
                            <td>Woreda</td>
                            <td>{{ order_item.order.woreda }}</td>
                        </tr>
                        <tr>
                            <td>Delivery Address</td>
                            <td>{{ order_item.order.address }}</td>
                        </tr>
                        <tr>
                            <td>Address Description</td>
                            <td>{{ order_item.order.address_opt }}</td>
                        </tr>
                        <tr>
                            <td>Phone Number</td>
                            <td>{{ order_item.order.phone }}</td>
                        </tr>
                        <tr>
                            <td>Email</td>
                            <td>{{ order_item.order.email }}</td>
                        </tr>
                        <tr>
                            <td>Order Note</td>
                            <td>{{ order_item.order.note }}</td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td>
                                <button value="{{ order_item.status }}" class="order-status active-status btn"
                                        onclick="orderStatusButtonClicked($(this))">
                                    {{ order_item.status }}
                                </button>

                                {% for status in order_states %}
                                    <button value="{{ status.lower }}" class="order-status btn" onclick="orderStatusButtonClicked($(this))">
                                        {{ status }}
                                    </button>
                                {% endfor %}
                            </td>
                        </tr>
                        </tbody>
                        <tfoot>

                        </tfoot>
                    </table>
                </article>
            </div>
            <div class="align-right">
                <a class="btn btn-black" href="{% url 'store:orders' order_item.pharmacy.pk %}">Orders</a>
            </div>
        </div>
    </div>
{% endblock content %}

{% block page_specific_script %}
    <script src="{% static 'store/custom/js/js.cookie-2.2.1.min.js' %}"></script>
    <script>
        let csrfToken = Cookies.get('csrftoken');

        function orderStatusButtonClicked(clickedStatusButton) {
            postOrderStatus(clickedStatusButton);
        }

        function postOrderStatus(clickedStatusButton) {
            let newStatus = clickedStatusButton.val();

            $.ajax({
                url: '',
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                data: {
                    'new_status': newStatus
                },
                success: () => {
                    changeButtonColor(clickedStatusButton);
                    // remove the 'active-status' class from the previously active order
                    // status button and add it to the newly active status button
                    $('.active-status').removeClass().addClass('btn');
                    clickedStatusButton.addClass('active-status');
                },
                error: () => {
                    alert('Could not change order status. Please try again later.');
                }
            });
        }

        function changeButtonColor(clickedStatusButton) {
            let appropriateClass;

            switch (clickedStatusButton.val().toUpperCase()) {
                case 'PENDING':
                    appropriateClass = 'btn-warning';
                    break;
                case 'REJECTED':
                    appropriateClass = 'btn-danger';
                    break;
                case 'DISPATCHED':
                    appropriateClass = 'btn-dark';
                    break;
                case 'COMPLETE':
                    appropriateClass = 'btn-success';
                    break;
                default:
                    appropriateClass = 'btn';
                    break;
            }

            clickedStatusButton.addClass(appropriateClass);
        }

        $(document).ready(changeButtonColor($('.active-status')));
    </script>
{% endblock page_specific_script %}
